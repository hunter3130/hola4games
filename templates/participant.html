{% extends 'base.html' %}

{% block title %}ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚{% endblock %}

{% block content %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/participant.css') }}">

<div class="container text-center">

  <h1 class="welcome-text">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h1>

  <!-- Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø«Ø§Ø¨Øª Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØ­Ø·ÙŠÙ†Ø§ Ù…ÙƒØ§Ù†Ù‡ div ÙØ§Ø¶ÙŠ Ø¨Ù†Ø¹Ø±Ø¶ ÙÙŠÙ‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
  <div id="team-cards-container" class="team-cards">
    <!-- Ù‡Ù†Ø§ Ù‡ÙŠØªØ¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ -->
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
<div class="helpers-container">
  {% set helpers = [
    {'id': 'ØªØ­Ø¯ÙŠ Ø§Ù„Ù‚Ø±ØµØ§Ù†', 'name': 'ØªØ­Ø¯ÙŠ Ø§Ù„Ù‚Ø±ØµØ§Ù†'},
    {'id': 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ†', 'name': 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ†'},
    {'id': 'ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„', 'name': 'ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„'},
    {'id': 'ØªÙ„Ù…ÙŠØ­', 'name': 'ØªÙ„Ù…ÙŠØ­ '},
    {'id': 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡', 'name': 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡'}]
  %}
  {% for helper in helpers %}
    <button class="helper-card" id="helper-{{ loop.index }}" onclick="useHelper({{ loop.index }}, '{{ helper.id }}')">
      {{ helper.name }}
    </button>
  {% endfor %}
</div>


<script>
 const socket = io();
// ÙÙŠ participant.html Ø¯Ø§Ø®Ù„ script
socket.on("connect", () => {
  // Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  socket.emit("get_initial_state");
  socket.emit("get_buzzer_state");
});

socket.on("initial_state", (data) => {
  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  if (data[team]) {
    Object.entries(data[team].helpers).forEach(([helper, used]) => {
      if (used) {
        document.querySelectorAll('.helper-card').forEach((btn) => {
          if (btn.innerText.includes(helper)) {
            btn.classList.add("disabled-card");
            btn.disabled = true;
            btn.innerText = helper + " âœ…";
          }
        });
      }
    });
  }
});

console.log({{ game_data | tojson | safe }});
console.log({{ team_state | tojson | safe }});

// const allTeamsState = {{ team_state | tojson | safe }};
const team =  "{{ team }}";
// const teamState = allTeamsState[team] || null;
const gameData = {{ game_data | tojson | safe }};
const teamState = {{ team_state | tojson | safe }};

const code = "{{ code }}";

if (!localStorage.getItem("team")) {
  localStorage.setItem("team", team);
}
if (!localStorage.getItem("code")) {
  localStorage.setItem("code", code);
}

function renderTeamCard() {
  const container = document.getElementById("team-cards-container");
  let cardHTML = "";

  if (team === "red") {
    cardHTML = `
      <div class="team-card" style="border-top: 5px solid #e74c3c;">
        <div class="team-name">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
        <div class="team-code">${code}</div>
        <div class="buzzer-container">
          <button id="buzzer-button" onclick="buzz()">ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø²Ø±</button>
        </div>
      </div>`;
  } else if (team === "blue") {
    cardHTML = `
      <div class="team-card" style="border-top: 5px solid #3498db;">
        <div class="team-name">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
        <div class="team-code">${code}</div>
        <div class="buzzer-container">
          <button id="buzzer-button" style="background-color: royalblue;" onclick="buzz()">ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø²Ø±</button>
        </div>
      </div>`;
  } else {
    cardHTML = `<div>Ø£Ù†Øª Ù„Ù… ØªÙ†Ø¶Ù… Ù„Ø£ÙŠ ÙØ±ÙŠÙ‚</div>`;
  }

  container.innerHTML = cardHTML;
}

function updateUIFromState() {
  const buzzerBtn = document.getElementById("buzzer-button");
  
  if (teamState) {
    if (teamState.buzzer_pressed) {
      buzzerBtn.disabled = true;
      buzzerBtn.innerText = "âœ… ØªÙ… Ø§Ù„Ø¶ØºØ·!";
      buzzerBtn.classList.add("buzzer-pressed");
    } else {
      buzzerBtn.disabled = false;
      buzzerBtn.innerText = "ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø²Ø±";
      buzzerBtn.classList.remove("buzzer-pressed");
    }

    Object.entries(teamState.helpers).forEach(([helperName, used]) => {
      if (used) {
        document.querySelectorAll('.helper-card').forEach((btn) => {
          if (btn.innerText.includes(helperName)) {
            btn.classList.add("disabled-card");
            btn.disabled = true;
            btn.innerText = helperName + " âœ…";
          }
        });
      }
    });
  }
}

renderTeamCard();
updateUIFromState();

function useHelper(index, helperName) {
  const card = document.getElementById(`helper-${index}`);
  if (card.classList.contains("disabled-card")) return;

  card.classList.add("disabled-card");
  card.innerText = helperName + " âœ…";
  card.disabled = true;

  socket.emit("helper_used", {
    team: team,
    helper: helperName
  });
}


function buzz() {
  if (!team) {
    alert("âš ï¸ Ø£Ù†Øª Ù„Ù… ØªÙ†Ø¶Ù… Ù„Ø£ÙŠ ÙØ±ÙŠÙ‚");
    return;
  }
  socket.emit("buzz", { team: team });

  const btn = document.getElementById("buzzer-button");
  btn.disabled = true;
  btn.innerText = "âœ… ØªÙ… Ø§Ù„Ø¶ØºØ·!";
  btn.classList.add("buzzer-pressed");
}

socket.on("buzz", (data) => {
  const winner = data.team;

  const buzzerBtn = document.getElementById("buzzer-button");
  if (team !== winner) {
    buzzerBtn.disabled = true;
    buzzerBtn.innerText = "â›” Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
  }
});

socket.on("buzzer_reset", () => {
  const buzzerBtn = document.getElementById("buzzer-button");
  if (buzzerBtn) {
    buzzerBtn.disabled = false;
    buzzerBtn.innerText = "ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø²Ø±";
    buzzerBtn.classList.remove("buzzer-pressed");
  }
});

socket.on("disable_helper", (data) => {
  const { team: usedTeam, helper } = data;
  if (team === usedTeam) {
    document.querySelectorAll('.helper-card').forEach((btn) => {
      if (btn.innerText.includes(helper)) {
        btn.classList.add("disabled-card");
        btn.disabled = true;
        btn.innerText = helper + " âœ…";
      }
    });
  }
});

</script>


<script src="{{ url_for('static', filename='js/hex.js') }}" defer></script>
{% endblock %}
