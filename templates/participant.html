{% extends 'base.html' %}
{% block title %}ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚{% endblock %}
{% block body_class %}participant-page{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/participant.css') }}">
{% endblock %}

{% block content %}
<div class="container text-center">
  <h1 class="welcome-text">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h1>

  <div class="team-cards">
    {% if team == 'red' %}
      <div class="team-card" style="border-top: 5px solid #e74c3c;">
        <div class="team-name">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
        <div class="team-code">{{ code }}</div>
      </div>
    {% elif team == 'blue' %}
      <div class="team-card" style="border-top: 5px solid #3498db;">
        <div class="team-name">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
        <div class="team-code">{{ code }}</div>
      </div>
    {% else %}
      <div>Ø£Ù†Øª Ù„Ù… ØªÙ†Ø¶Ù… Ù„Ø£ÙŠ ÙØ±ÙŠÙ‚</div>
    {% endif %}
  </div>

  <div class="helpers-container">
    {% set helpers = ['ØªØ­Ø¯ÙŠ Ø§Ù„Ù‚Ø±ØµØ§Ù†', 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ†', 'ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„', 'Ø·Ù„Ø¨ Ø®ÙŠØ§Ø±Ø§Øª', 'ØªÙ„Ù…ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©', 'ÙƒØ±Øª Ø£Ø­Ù…Ø±'] %}
    {% for helper in helpers %}
      <button class="helper-card" id="helper-{{ loop.index }}" onclick="useHelper({{ loop.index }}, '{{ helper }}')">
        {{ helper }}
      </button>
    {% endfor %}
  </div>
</div>

<script>
  const socket = io();

  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙˆÙ„ Ù…Ø±Ø©
  const serverTeam = "{{ team }}";
  const serverCode = "{{ code }}";

  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£ØµÙ„Ø§Ù‹
  if (!localStorage.getItem("team")) {
    localStorage.setItem("team", serverTeam);
    localStorage.setItem("code", serverCode);
  }

  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒØ¨Ø¯ÙŠÙ„
  const team = localStorage.getItem("team") || serverTeam;
  const code = localStorage.getItem("code") || serverCode;

  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
  function renderTeamCard() {
    const container = document.getElementById("team-cards-container");
    let cardHTML = "";

    if (team === "red") {
      cardHTML = `
        <div class="team-card" style="border-top: 5px solid #e74c3c;">
          <div class="team-name">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
          <div class="team-code">${code}</div>
          <div class="buzzer-container">
            <button id="buzzer-button" onclick="buzz()">ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø²Ø±</button>
          </div>
        </div>`;
    } else if (team === "blue") {
      cardHTML = `
        <div class="team-card" style="border-top: 5px solid #3498db;">
          <div class="team-name">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
          <div class="team-code">${code}</div>
          <div class="buzzer-container">
            <button id="buzzer-button" style="background-color: royalblue;" onclick="buzz()">ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø²Ø±</button>
          </div>
        </div>`;
    } else {
      cardHTML = `<div>Ø£Ù†Øª Ù„Ù… ØªÙ†Ø¶Ù… Ù„Ø£ÙŠ ÙØ±ÙŠÙ‚</div>`;
    }

    container.innerHTML = cardHTML;
  }

  // Ù†Ù†ÙØ° Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  renderTeamCard();

  // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
  function useHelper(index, helperName) {
    const card = document.getElementById(`helper-${index}`);
    if (card.classList.contains("disabled-card")) return;

    card.classList.add("disabled-card");
    card.innerText = helperName + " âœ…";
    card.disabled = true;

    socket.emit("helper_used", {
      team: "{{ team }}",
      helper: helperName
    });
  }

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø²Ø±
  function buzz() {
    if (!team) {
      alert("âš ï¸ Ø£Ù†Øª Ù„Ù… ØªÙ†Ø¶Ù… Ù„Ø£ÙŠ ÙØ±ÙŠÙ‚");
      return;
    }
    socket.emit("buzz", { team: team });

    const btn = document.getElementById("buzzer-button");
    btn.disabled = true;
    btn.innerText = "âœ… ØªÙ… Ø§Ù„Ø¶ØºØ·!";
    btn.classList.add("buzzer-pressed");
  }

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  socket.on("buzz", (data) => {
    const winner = data.team;
    const myTeam = team;

    const buzzerBtn = document.getElementById("buzzer-button");
    if (myTeam !== winner) {
      buzzerBtn.disabled = true;
      buzzerBtn.innerText = "â›” Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
    }
  });

  // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø²Ø± Ø§Ù„Ø¨Ø§Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  socket.on("buzzer_reset", () => {
    const buzzerBtn = document.getElementById("buzzer-button");
    if (buzzerBtn) {
      buzzerBtn.disabled = false;
      buzzerBtn.innerText = "ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø²Ø±";
      buzzerBtn.classList.remove("buzzer-pressed");
    }
  });
</script>
{% endblock %}
